<template>
  <section id="site">
    <div class="px-20 max-w-xl mx-auto space-y-4 my-5">
      <BootstrapWrapper @rabbit-mq="handleTestRabbitMQEvent" @quart="handleTestQuartBackend" @quart-ws="handleTestQuartWebsocket" @login="handleTestAuthentication" />
      <VoltWrapper />
    </div>
  </section>
</template>

<script setup lang="ts">
type WebsocketData = {
  state: boolean
}

useSeoMeta({
  title: 'Home',
  titleTemplate: '%s | Frontend',
  description: 'Some simple description'
})

// const isLoading = ref<boolean>(false)
const showAlert = ref<boolean>(false)
const isWebsocket = ref<boolean>(false)
const websocketCounter = ref<WebsocketData[]>([])

const ws = useWebSocket('http://api.johnpm.fr/ws/test', {
  immediate: false,
  onConnected() {
    isWebsocket.value = true
    showAlert.value = true
  },
  onMessage(_ws, event) {
    websocketCounter.value.push(JSON.parse(event.data))
  },
  onError() {
    isWebsocket.value = false
    showAlert.value = false
  },
  onDisconnected() {
    isWebsocket.value = false
    showAlert.value = false
  }
})

const eventData = ref<string>('')
const errorMessage = ref<string>('')
const showError = ref<boolean>(false)

const websocketOpened = computed(() => {
  return ws.status.value === 'OPEN'
})

provide('websocketOpened', websocketOpened)
provide('eventData', eventData)

/**
 *
 */
async function handleTestRabbitMQEvent() {
  // try {
  //   isLoading.value = true

  //   const response = await client.post('/test')

  //   if (response.status === 200) {
  //     showAlert.value = true
  //   }

  //   isLoading.value = false
  // } catch (e) {
  //   errorMessage.value = `Could not send event: ${e}`
  //   showError.value = true
  // }
}

/**
 *
 */
async function handleTestQuartBackend() {
  // try {
  //   isLoading.value = true

  //   const { client } = useAxiosClient(null, 5000)
  //   const response = await client.post('/test')

  //   if (response.status === 200) {
  //     showAlert.value = true
  //   }
  //   isLoading.value = false
  // } catch (e) {
  //   errorMessage.value = `Could not contact quart API: ${e}`
  //   showError.value = true
  // }
}

/**
 *
 */
async function handleTestQuartWebsocket() {
  try {
    ws.open()
  } catch (e) {
    errorMessage.value = `Could not connect to websocket: ${e}`
    showError.value = true
  }
}

/**
 *
 */
async function handleTestAuthentication() {
  // try {
  //   const { authenticatedClient: client } = useAuthenticatedAxiosClient()
  //   const response = await client.get('/schools/v1/test-authenticated')

  //   if (response.status === 200) {
  //     showAlert.value = true
  //   }
  // } catch (e) {
  //   errorMessage.value = `Could not contact quart API: ${e}`
  //   showError.value = true
  // }
}

onMounted(() => {
  const html = document.querySelector('html')
  if (isDefined(html)) {
    html.classList.add('dark:bg-slate-900', 'dark:text-gray-200')
  }
})
</script>
